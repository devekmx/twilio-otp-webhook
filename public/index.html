<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>Devek Sourcing</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; overscroll-behavior: none; }
    .bubble-in  { background: #f0f0f0; border-radius: 0 14px 14px 14px; }
    .bubble-out { background: #dcf8c6; border-radius: 14px 0 14px 14px; }
    #messages   { scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
    #thread-list { -webkit-overflow-scrolling: touch; }
    /* Mobile: ocultar panel inactivo */
    @media (max-width: 767px) {
      #panel-threads { display: flex; flex-direction: column; }
      #panel-chat    { display: none; flex-direction: column; }
      body.chat-open #panel-threads { display: none; }
      body.chat-open #panel-chat    { display: flex; }
    }
    /* Desktop: ambos visibles */
    @media (min-width: 768px) {
      #panel-threads { display: flex !important; flex-direction: column; width: 320px; flex-shrink: 0; }
      #panel-chat    { display: flex !important; flex-direction: column; flex: 1; }
    }
  </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">

<!-- â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="auth-screen" class="hidden fixed inset-0 bg-gray-900/80 flex items-center justify-center z-50 p-4">
  <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm flex flex-col gap-4">

    <div id="step-key">
      <div class="text-3xl mb-2">ğŸ”‘</div>
      <h2 class="text-xl font-bold text-gray-800 mb-1">Acceso</h2>
      <p class="text-sm text-gray-500 mb-4">Ingresa tu clave de acceso</p>
      <input id="key-input" type="password" placeholder="oc_..."
        class="w-full border border-gray-300 rounded-xl px-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-green-400 mb-3" />
      <button onclick="doStep1()"
        class="w-full bg-green-500 active:bg-green-700 text-white rounded-xl px-4 py-3 text-base font-semibold">
        Continuar â†’
      </button>
    </div>

    <div id="step-totp" class="hidden">
      <div class="text-3xl mb-2">ğŸ“±</div>
      <h2 class="text-xl font-bold text-gray-800 mb-1">VerificaciÃ³n 2FA</h2>
      <p class="text-sm text-gray-500 mb-4">CÃ³digo de Google Authenticator</p>
      <input id="totp-input" type="tel" inputmode="numeric" pattern="[0-9]*"
        placeholder="000 000" maxlength="6"
        class="w-full border border-gray-300 rounded-xl px-4 py-3 text-2xl text-center tracking-widest font-mono focus:outline-none focus:ring-2 focus:ring-green-400 mb-3" />
      <button onclick="doStep2()"
        class="w-full bg-green-500 active:bg-green-700 text-white rounded-xl px-4 py-3 text-base font-semibold">
        Verificar âœ“
      </button>
      <button onclick="backToStep1()" class="w-full text-sm text-gray-400 mt-2 py-2">
        â† Cambiar clave
      </button>
    </div>

    <p id="auth-error" class="text-red-500 text-sm hidden text-center font-medium"></p>
  </div>
</div>

<!-- â”€â”€ APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="app" class="hidden flex-col h-screen overflow-hidden" style="display:none">

  <!-- Header -->
  <div class="bg-green-600 text-white px-4 py-3 flex items-center justify-between shadow-md flex-shrink-0">
    <!-- Back button (mobile only) -->
    <button id="btn-back" onclick="goBack()"
      class="md:hidden mr-2 text-white text-xl px-1 hidden">â€¹</button>
    <div class="flex items-center gap-3 flex-1 min-w-0">
      <span class="text-2xl flex-shrink-0">ğŸ’¬</span>
      <div class="min-w-0">
        <div id="header-title" class="font-bold text-sm truncate">Devek Sourcing</div>
        <div id="status-bar" class="text-xs opacity-75 truncate">Cargando...</div>
      </div>
    </div>
    <div class="flex items-center gap-3 flex-shrink-0">
      <a id="header-alibaba" href="#" target="_blank"
        class="hidden text-xs bg-white/20 rounded-lg px-2 py-1 hover:bg-white/30">Alibaba â†—</a>
      <button onclick="logout()" class="text-xs opacity-70 hover:opacity-100 px-1">Salir</button>
    </div>
  </div>

  <!-- Body -->
  <div class="flex flex-1 overflow-hidden">

    <!-- â”€â”€ Panel izquierdo: threads â”€â”€ -->
    <div id="panel-threads" class="bg-white border-r border-gray-200 overflow-hidden">
      <div class="px-3 py-2 border-b border-gray-100 flex-shrink-0">
        <input id="search" type="search" placeholder="ğŸ” Buscar..."
          oninput="filterThreads()"
          class="w-full text-sm border border-gray-200 rounded-xl px-3 py-2 focus:outline-none focus:ring-1 focus:ring-green-400" />
      </div>
      <div id="thread-list" class="overflow-y-auto flex-1">
        <div class="text-center text-gray-400 text-sm py-10">Cargando...</div>
      </div>
    </div>

    <!-- â”€â”€ Panel derecho: chat â”€â”€ -->
    <div id="panel-chat" class="bg-gray-50 overflow-hidden">

      <!-- Empty state (solo desktop) -->
      <div id="empty-state" class="hidden md:flex flex-1 items-center justify-center text-gray-400">
        <div class="text-center">
          <div class="text-5xl mb-3">ğŸ’¬</div>
          <div class="text-sm">Selecciona una conversaciÃ³n</div>
        </div>
      </div>

      <!-- Chat activo -->
      <div id="chat-area" class="hidden flex-col h-full overflow-hidden">
        <!-- Mensajes -->
        <div id="messages" class="flex-1 overflow-y-auto px-3 py-3 flex flex-col gap-2"></div>

        <!-- Input -->
        <div class="bg-white border-t border-gray-200 px-3 py-2 flex gap-2 items-end flex-shrink-0">
          <textarea id="msg-input" rows="1"
            placeholder="Mensaje... (Enter = enviar)"
            onkeydown="handleKey(event)"
            oninput="autoResize(this)"
            class="flex-1 border border-gray-200 rounded-2xl px-4 py-2 text-base resize-none focus:outline-none focus:ring-2 focus:ring-green-400 max-h-28 leading-normal"></textarea>
          <button onclick="sendMessage()"
            class="bg-green-500 active:bg-green-700 text-white rounded-2xl w-11 h-11 flex items-center justify-center flex-shrink-0 text-xl shadow">
            â¤
          </button>
        </div>

        <!-- Aviso 24h -->
        <div id="window-warning" class="hidden bg-amber-50 border-t border-amber-200 px-4 py-2 text-xs text-amber-700 flex-shrink-0">
          âš ï¸ MÃ¡s de 24h sin respuesta â€” solo templates disponibles. El mensaje libre puede fallar.
        </div>
      </div>

    </div>
  </div>
</div>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let SESSION = '', tempKey = '', threads = [], activePhone = null, pollInterval = null;

function authHeader() { return { 'x-session-token': SESSION }; }

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function init() {
  SESSION = localStorage.getItem('oc_session') || '';
  if (SESSION) showApp();
  else document.getElementById('auth-screen').classList.remove('hidden');
}

// â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showError(msg) {
  const el = document.getElementById('auth-error');
  el.textContent = msg; el.classList.remove('hidden');
}

async function doStep1() {
  const key = document.getElementById('key-input').value.trim();
  if (!key) return;
  document.getElementById('auth-error').classList.add('hidden');
  try {
    const r = await fetch('/ui/auth', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ key })
    });
    const d = await r.json();
    if (d.ok && d.step === 'totp') {
      tempKey = key;
      document.getElementById('step-key').classList.add('hidden');
      document.getElementById('step-totp').classList.remove('hidden');
      setTimeout(() => document.getElementById('totp-input').focus(), 100);
    } else showError(d.error || 'Error');
  } catch { showError('Error de red'); }
}

async function doStep2() {
  const code = document.getElementById('totp-input').value.replace(/\D/g,'').trim();
  if (code.length !== 6) return;
  document.getElementById('auth-error').classList.add('hidden');
  try {
    const r = await fetch('/ui/auth', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ key: tempKey, code })
    });
    const d = await r.json();
    if (d.ok && d.token) {
      SESSION = d.token; tempKey = '';
      localStorage.setItem('oc_session', SESSION);
      document.getElementById('auth-screen').classList.add('hidden');
      showApp();
    } else {
      showError(d.error || 'CÃ³digo incorrecto');
      document.getElementById('totp-input').value = '';
      document.getElementById('totp-input').focus();
    }
  } catch { showError('Error de red'); }
}

function backToStep1() {
  tempKey = '';
  document.getElementById('step-totp').classList.add('hidden');
  document.getElementById('step-key').classList.remove('hidden');
  document.getElementById('totp-input').value = '';
  document.getElementById('auth-error').classList.add('hidden');
}

function logout() { localStorage.removeItem('oc_session'); location.reload(); }

function showApp() {
  const app = document.getElementById('app');
  app.style.display = '';
  app.classList.remove('hidden');
  app.classList.add('flex');
  loadThreads();
  pollInterval = setInterval(loadThreads, 6000);
}

// â”€â”€ Mobile nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function goBack() {
  document.body.classList.remove('chat-open');
  document.getElementById('btn-back').classList.add('hidden');
  document.getElementById('header-title').textContent = 'Devek Sourcing';
  document.getElementById('header-alibaba').classList.add('hidden');
  activePhone = null;
}

// â”€â”€ Threads â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadThreads() {
  try {
    const r = await fetch('/dashboard/threads', { headers: authHeader() });
    if (r.status === 401) { logout(); return; }
    threads = await r.json();
    renderThreads();
    document.getElementById('status-bar').textContent =
      `${threads.length} conversaciÃ³n${threads.length !== 1 ? 'es' : ''} Â· ${new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`;
    if (activePhone) loadChat(activePhone);
  } catch { document.getElementById('status-bar').textContent = 'Sin conexiÃ³n'; }
}

function filterThreads() { renderThreads(); }

function renderThreads() {
  const q = (document.getElementById('search').value || '').toLowerCase();
  const list = threads.filter(t =>
    !q || (t.supplier_name||'').toLowerCase().includes(q) || (t.supplier_phone||'').includes(q)
  );
  const el = document.getElementById('thread-list');
  if (!list.length) {
    el.innerHTML = '<div class="text-center text-gray-400 text-sm py-10">Sin resultados</div>'; return;
  }
  el.innerHTML = list.map(t => {
    const active = t.supplier_phone === activePhone;
    const name = t.supplier_name || t.supplier_phone;
    const last = (t.last_body || '').slice(0, 55) + ((t.last_body||'').length > 55 ? 'â€¦' : '');
    const ts = t.last_ts ? relTime(new Date(t.last_ts)) : '';
    return `<div onclick="selectThread('${esc(t.supplier_phone)}')"
      class="px-4 py-4 border-b border-gray-100 cursor-pointer active:bg-gray-100
             ${active ? 'bg-green-50 border-l-4 border-l-green-500' : 'hover:bg-gray-50'}">
      <div class="flex justify-between items-start mb-1">
        <div class="font-semibold text-sm text-gray-900 truncate flex-1">${esc(name)}</div>
        <div class="text-xs text-gray-400 ml-3 flex-shrink-0">${ts}</div>
      </div>
      <div class="text-sm text-gray-500 truncate">${esc(last)}</div>
    </div>`;
  }).join('');
}

// â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function selectThread(phone) {
  activePhone = phone;
  renderThreads();
  const thread = threads.find(t => t.supplier_phone === phone) || {};
  const name = thread.supplier_name || phone;

  // Mobile: ir al chat
  document.body.classList.add('chat-open');
  document.getElementById('btn-back').classList.remove('hidden');
  document.getElementById('header-title').textContent = name;

  if (thread.alibaba_url) {
    const a = document.getElementById('header-alibaba');
    a.href = thread.alibaba_url; a.classList.remove('hidden');
  } else {
    document.getElementById('header-alibaba').classList.add('hidden');
  }

  document.getElementById('empty-state').classList.add('hidden');
  document.getElementById('chat-area').classList.remove('hidden');
  document.getElementById('chat-area').classList.add('flex');
  await loadChat(phone);
}

async function loadChat(phone) {
  if (activePhone !== phone) return;
  try {
    const r = await fetch(`/dashboard/thread/${encodeURIComponent(phone)}`, { headers: authHeader() });
    const msgs = await r.json();
    const el = document.getElementById('messages');
    const atBottom = el.scrollHeight - el.clientHeight - el.scrollTop < 60;
    el.innerHTML = msgs.length
      ? msgs.map(renderBubble).join('')
      : '<div class="text-center text-gray-400 text-sm py-6">Sin mensajes</div>';
    if (atBottom || msgs.length <= 5) el.scrollTop = el.scrollHeight;

    const lastIn = [...msgs].reverse().find(m => m.direction === 'inbound');
    const warn = document.getElementById('window-warning');
    if (lastIn) {
      warn.classList.toggle('hidden', (Date.now() - new Date(lastIn.created_at)) < 86400000);
    } else { warn.classList.add('hidden'); }
  } catch {}
}

function renderBubble(m) {
  const out = m.direction === 'outbound';
  const time = new Date(m.created_at).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  return `<div class="flex ${out ? 'justify-end' : 'justify-start'}">
    <div class="${out ? 'bubble-out' : 'bubble-in'} max-w-[78vw] md:max-w-md px-3 py-2 shadow-sm">
      <div class="text-sm text-gray-800 whitespace-pre-wrap break-words leading-relaxed">${esc(m.body)}</div>
      <div class="text-right text-xs text-gray-400 mt-1">${time}</div>
    </div>
  </div>`;
}

// â”€â”€ Send â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendMessage() {
  const input = document.getElementById('msg-input');
  const body = input.value.trim();
  if (!body || !activePhone) return;
  input.value = ''; input.style.height = 'auto';
  try {
    const r = await fetch('/whatsapp/send_message', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', ...authHeader() },
      body: JSON.stringify({ to: activePhone, body })
    });
    const d = await r.json();
    if (!d.ok) alert('Error: ' + (d.error || 'desconocido'));
    else await loadChat(activePhone);
  } catch { alert('Error de red'); }
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 112) + 'px';
}

// â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) {
  return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
function relTime(d) {
  const s = (Date.now() - d) / 1000;
  if (s < 60) return 'ahora';
  if (s < 3600) return Math.floor(s/60) + 'm';
  if (s < 86400) return Math.floor(s/3600) + 'h';
  return d.toLocaleDateString([], {day:'numeric', month:'short'});
}

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();
document.getElementById('key-input')?.addEventListener('keydown', e => { if (e.key==='Enter') doStep1(); });
document.getElementById('totp-input')?.addEventListener('keydown', e => { if (e.key==='Enter') doStep2(); });
document.getElementById('totp-input')?.addEventListener('input', e => {
  if (e.target.value.replace(/\D/g,'').length === 6) doStep2();
});
</script>
</body>
</html>
